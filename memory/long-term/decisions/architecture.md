# 架构决策记录 (Architecture Decision Records)

---

## ADR-001: 添加飞书消息 `create_time` 字段支持

**状态**: ✅ 已实施
**日期**: 2026-03-01
**决策人**: 老板 (易彬)

### 背景
飞书消息出现延迟（1小时），但系统无法识别消息的真实发送时间。`timestamp` 字段是收到时间，不是发送时间。

### 问题
- 无法准确判断消息是否延迟
- 无法识别延迟消息的严重程度
- 可能影响响应的及时性

### 考虑的方案

| 方案 | 描述 | 优缺点 |
|-----|------|--------|
| A | 使用现有 `timestamp` | ❌ 无法识别延迟 |
| B | 修改源码添加 `create_time` | ✅ 准确识别，需修改源码 |
| C | 实时查询飞书API | ❌ 太慢，增加延迟 |

### 决策
选择 **方案B**：修改 OpenClaw 飞书插件源码

### 实施
- 修改 `/usr/lib/node_modules/openclaw/extensions/feishu/src/bot.ts`
  - 在 `FeishuMessageEvent` 类型中添加 `create_time?: string`
  - 在 `buildFeishuMessageContext` 中解析并传递 `createTime`
- 修改 `/usr/lib/node_modules/openclaw/extensions/feishu/src/types.ts`
  - 在 `FeishuMessageContext` 中添加 `createTime?: number`

### 后果
- ✅ 能准确识别消息延迟
- ✅ 可自动提示延迟消息
- ⚠️ 需要维护源码修改（OpenClaw升级时需重新应用）

---

## ADR-002: 豆包手机协作方案 - 定时轮询模式

**状态**: ✅ 已决策，待实施
**日期**: 2026-03-01
**决策人**: 老板 (易彬)

### 背景
需要将扣子虾（云端AI）与豆包手机AI（本地系统AI）协同工作。豆包有完整系统权限，但需要被主动唤醒。

### 约束
- 豆包无法后台持续监听
- 需要被用户说"豆包豆包"唤醒
- 支持定时任务和即时任务
- 后台运行不打扰用户使用手机

### 考虑的方案

| 方案 | 描述 | 及时性 | 干扰度 | 可行性 |
|-----|------|--------|--------|--------|
| A | 用户手动触发 | ⭐⭐⭐ | ⭐ | ⭐⭐⭐ |
| B | 定时轮询（15分钟） | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| C | 定时轮询（30分钟） | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| D | 云端任务队列 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |

### 决策
选择 **方案C**：每30分钟定时轮询

**理由**:
- 平衡及时性和省电
- 不打扰用户正常使用
- 后台静默执行

### 实施计划
- 设置豆包定时任务
- 检查频率: 每30分钟
- 识别标记: "#豆包"
- 操作: 打开飞书 → 检查消息 → 执行 → 回复

### 后果
- ✅ 无需用户频繁手动触发
- ✅ 后台静默，不打扰
- ⚠️ 最大延迟30分钟

---

## ADR-003: 分层记忆系统设计

**状态**: ✅ 已实施
**日期**: 2026-03-01
**决策人**: 老板 (易彬)

### 背景
需要记录所有对话和工作，形成长期记忆，提高效率。参考傅盛的分层记忆理念和业界最佳实践。

### 问题
- 简单分类（按文件类型）不够科学
- 信息膨胀，难以检索
- 短期和长期信息混在一起

### 考虑的方案

| 方案 | 描述 | 优点 | 缺点 |
|-----|------|------|------|
| A | 简单分类（原方案） | 简单直观 | 无法区分记忆生命周期 |
| B | 分层记忆（新方案） | 科学管理，自动蒸馏 | 初期设置复杂 |
| C | 数据库存储 | 检索强大 | 依赖外部系统 |

### 决策
选择 **方案B**：四层分层记忆系统

```
Layer 3: 长期记忆 (永久)
Layer 2: 短期记忆 (几天-几周)
Layer 1: 工作记忆 (当前会话)
Layer 0: 原始记录 (备份)
```

### 核心机制
- **实时记录**: 逐条追加到工作记忆
- **会话结束**: 提炼到短期记忆
- **每日蒸馏**: 短期 → 长期
- **每周归档**: 清理过期记忆

### 文件结构
```
memory/
├── working/         # Layer 1
├── short-term/      # Layer 2
├── long-term/       # Layer 3
└── raw/             # Layer 0
```

### 后果
- ✅ 信息按生命周期管理
- ✅ 自动提炼，避免膨胀
- ✅ 支持语义标签，便于检索
- ⚠️ 需要定期维护（每周回顾）

---

*维护者: 扣子虾*
*更新频率: 每次重大决策*